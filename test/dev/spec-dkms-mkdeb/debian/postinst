#!/bin/sh
# Copyright (C) 2002-2005 Flavio Stanchina
# Copyright (C) 2005-2006 Aric Cyr
# Copyright (C) 2007 Mario Limonciello
# Copyright (C) 2009 Alberto Milone

set -e

NAME=MODULE_NAME
PACKAGE_NAME=$NAME-dkms
DEB_NAME=$(echo $PACKAGE_NAME | sed 's,_,-,')
#CVERSION=`dpkg-query -W -f='${Version}' $DEB_NAME | awk -F "-" '{print $1}' | cut -d\: -f2`
CVERSION=`dpkg-query -W -f='${Version}' $DEB_NAME `
ARCH=`dpkg --print-architecture`

setup_theia () {
#FULL_VERSION=`dpkg-query -W -f='${Version}' $DEB_NAME`
DIR=/usr/src/spec-${CVERSION}

if [ -d /etc/modules-load.d ]; then
        cp ${DIR}/theia.conf /etc/modules-load.d
else
        grep -q '^spec$' /etc/modules || \
        echo spec >> /etc/modules
fi
cp ${DIR}/99-theia-spec.rules /etc/udev/rules.d

if [ ! -e /debug ]; then
    ln -s /sys/kernel/debug /debug
fi

if [ ! -e /data ]; then
    mkdir /data 2>/dev/null || true
fi

cp ${DIR}/apparmor.tunables.theia /etc/apparmor.d/tunables/multiarch.d/theia
cp ${DIR}/apparmor.abstractions.theia /etc/apparmor.d/abstractions/theia
if ! grep -q '#include.*theia' /etc/apparmor.d/abstractions/base
then
    echo '#include <abstractions/theia>' >>/etc/apparmor.d/abstractions/base
    service apparmor reload
fi

}

dkms_configure () {
	setup_theia
	for POSTINST in /usr/lib/dkms/common.postinst "/usr/share/$PACKAGE_NAME/postinst"; do
		if [ -f "$POSTINST" ]; then
			"$POSTINST" "$NAME" "$CVERSION" "/usr/share/$PACKAGE_NAME" "$ARCH" "$2"
			return $?
		fi
		echo "WARNING: $POSTINST does not exist." >&2
	done
	echo "ERROR: DKMS version is too old and $PACKAGE_NAME was not" >&2
	echo "built with legacy DKMS support." >&2
	echo "You must either rebuild $PACKAGE_NAME with legacy postinst" >&2
	echo "support or upgrade DKMS to a more current version." >&2
	return 1
}

case "$1" in
	configure)
		dkms_configure
	;;

	abort-upgrade|abort-remove|abort-deconfigure)
	;;

	*)
		echo "postinst called with unknown argument \`$1'" >&2
		exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
